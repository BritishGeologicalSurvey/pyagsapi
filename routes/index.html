
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../bgs_rules/">
      
      
        <link rel="next" href="../conversion/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>routes.py - Official documentation - pyagsapi</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#app.routes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Official documentation - pyagsapi" class="md-header__button md-logo" aria-label="Official documentation - pyagsapi" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Official documentation - pyagsapi
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              routes.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="lime"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/BritishGeologicalSurvey/pyagsapi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Official documentation - pyagsapi" class="md-nav__button md-logo" aria-label="Official documentation - pyagsapi" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Official documentation - pyagsapi
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/BritishGeologicalSurvey/pyagsapi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Code
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../main/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    main.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    validation.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bgs_rules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    bgs_rules.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    routes.py
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    routes.py
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#app.routes" class="md-nav__link">
    <span class="md-ellipsis">
      routes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.prepare_validation_response" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_validation_response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.convert" class="md-nav__link">
    <span class="md-ellipsis">
      convert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.get_ags_log" class="md-nav__link">
    <span class="md-ellipsis">
      get_ags_log
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.ags_export" class="md-nav__link">
    <span class="md-ellipsis">
      ags_export
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.ags_export_by_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      ags_export_by_polygon
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.prepare_count_response" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_count_response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.get_request_url" class="md-nav__link">
    <span class="md-ellipsis">
      get_request_url
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conversion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    conversion.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../checkers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    checkers.py
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    errors.py
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#app.routes" class="md-nav__link">
    <span class="md-ellipsis">
      routes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.prepare_validation_response" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_validation_response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.convert" class="md-nav__link">
    <span class="md-ellipsis">
      convert
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.get_ags_log" class="md-nav__link">
    <span class="md-ellipsis">
      get_ags_log
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.ags_export" class="md-nav__link">
    <span class="md-ellipsis">
      ags_export
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.ags_export_by_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      ags_export_by_polygon
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.prepare_count_response" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_count_response
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.routes.get_request_url" class="md-nav__link">
    <span class="md-ellipsis">
      get_request_url
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>routes.py</h1>

<div class="doc doc-object doc-module">



<a id="app.routes"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.routes.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">(</span><span class="n">background_tasks</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">validation_file</span><span class="p">,</span> <span class="n">std_dictionary</span><span class="o">=</span><span class="n">dictionary_form</span><span class="p">,</span> <span class="n">checkers</span><span class="o">=</span><span class="n">validate_form</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">format_form</span><span class="p">,</span> <span class="n">return_geometry</span><span class="o">=</span><span class="n">geometry_form</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Validate an AGS4 file to the AGS File Format v4.x rules and the NGDC data submission requirements.
Uses the Official AGS4 Python Library.
:param background_tasks: Background tasks for deleting temporary directories.
:type background_tasks: BackgroundTasks
:param files: List of AGS4 files to be validated.
:type files: List[UploadFile]
:param std_dictionary: The standard dictionary to use for validation. Options are "BGS" or "AGS".
:type std_dictionary: Dictionary
:param checkers: List of validation rules to be used during validation.
:type checkers: List[Checker]</p>
<p>:param fmt: The format to return the validation results in. Options are "text" or "json".
:type fmt: Format
:param return_geometry: Include GeoJSON in validation response. Options are True or False.
:type return_geometry: bool
:param request: The request object.
:type request: Request
:return: A response with the validation results in either plain text or JSON format.
:rtype: Union[FileResponse, ValidationResponse]
:raises InvalidPayloadError: If the payload is missing files or checkers.</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/validate/&quot;</span><span class="p">,</span>
             <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">],</span>
             <span class="n">response_model</span><span class="o">=</span><span class="n">ValidationResponse</span><span class="p">,</span>
             <span class="n">responses</span><span class="o">=</span><span class="n">log_responses</span><span class="p">,</span>
             <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Validate AGS4 File(s)&quot;</span><span class="p">,</span>
             <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Validate an AGS4 file to the AGS File Format v4.x rules and the NGDC data&quot;</span>
                          <span class="s2">&quot; submission requirements. Uses the Offical AGS4 Python Library.&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
                   <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UploadFile</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_file</span><span class="p">,</span>
                   <span class="n">std_dictionary</span><span class="p">:</span> <span class="n">Dictionary</span> <span class="o">=</span> <span class="n">dictionary_form</span><span class="p">,</span>
                   <span class="n">checkers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Checker</span><span class="p">]</span> <span class="o">=</span> <span class="n">validate_form</span><span class="p">,</span>
                   <span class="n">fmt</span><span class="p">:</span> <span class="n">Format</span> <span class="o">=</span> <span class="n">format_form</span><span class="p">,</span>
                   <span class="n">return_geometry</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">geometry_form</span><span class="p">,</span>
                   <span class="n">request</span><span class="p">:</span> <span class="n">Request</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate an AGS4 file to the AGS File Format v4.x rules and the NGDC data submission requirements.</span>
<span class="sd">    Uses the Official AGS4 Python Library.</span>
<span class="sd">    :param background_tasks: Background tasks for deleting temporary directories.</span>
<span class="sd">    :type background_tasks: BackgroundTasks</span>
<span class="sd">    :param files: List of AGS4 files to be validated.</span>
<span class="sd">    :type files: List[UploadFile]</span>
<span class="sd">    :param std_dictionary: The standard dictionary to use for validation. Options are &quot;BGS&quot; or &quot;AGS&quot;.</span>
<span class="sd">    :type std_dictionary: Dictionary</span>
<span class="sd">    :param checkers: List of validation rules to be used during validation.</span>
<span class="sd">    :type checkers: List[Checker]</span>

<span class="sd">    :param fmt: The format to return the validation results in. Options are &quot;text&quot; or &quot;json&quot;.</span>
<span class="sd">    :type fmt: Format</span>
<span class="sd">    :param return_geometry: Include GeoJSON in validation response. Options are True or False.</span>
<span class="sd">    :type return_geometry: bool</span>
<span class="sd">    :param request: The request object.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :return: A response with the validation results in either plain text or JSON format.</span>
<span class="sd">    :rtype: Union[FileResponse, ValidationResponse]</span>
<span class="sd">    :raises InvalidPayloadError: If the payload is missing files or checkers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">checkers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidPayloadError</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">checkers</span> <span class="o">=</span> <span class="p">[</span><span class="n">checker_functions</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checkers</span><span class="p">]</span>

    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">std_dictionary</span> <span class="o">==</span> <span class="n">Dictionary</span><span class="o">.</span><span class="n">None_Given</span><span class="p">:</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Standard_dictionary_</span><span class="si">{</span><span class="n">std_dictionary</span><span class="si">}</span><span class="s1">.ags&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">local_ags_file</span> <span class="o">=</span> <span class="n">tmp_dir</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">local_ags_file</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
            <span class="n">local_ags_file</span><span class="p">,</span> <span class="n">checkers</span><span class="o">=</span><span class="n">checkers</span><span class="p">,</span> <span class="n">standard_AGS4_dictionary</span><span class="o">=</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_geometry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">geojson</span> <span class="o">=</span> <span class="n">extract_geojson</span><span class="p">(</span><span class="n">local_ags_file</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;geojson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geojson</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;geojson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;geojson_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ve</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">Format</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span>
        <span class="n">full_logfile</span> <span class="o">=</span> <span class="n">tmp_dir</span> <span class="o">/</span> <span class="s1">&#39;results.log&#39;</span>
        <span class="k">with</span> <span class="n">full_logfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">log</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">to_plain_text</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">full_logfile</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">prepare_validation_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.prepare_validation_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_validation_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Package the data into a Response schema object</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_validation_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Package the data into a Response schema object&quot;&quot;&quot;</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1"> files validated&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
        <span class="s1">&#39;self&#39;</span><span class="p">:</span> <span class="n">get_request_url</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ValidationResponse</span><span class="p">(</span><span class="o">**</span><span class="n">response_data</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.convert" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">convert</span><span class="p">(</span><span class="n">background_tasks</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">conversion_file</span><span class="p">,</span> <span class="n">sort_tables</span><span class="o">=</span><span class="n">sort_tables_form</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Convert files between .ags and .xlsx format. Option to sort worksheets in .xlsx file in alphabetical order.
:param background_tasks: A background task that manages file conversion asynchronously.
:type background_tasks: BackgroundTasks
:param files: A list of files to be converted. Must be in .ags or .xlsx format.
:type files: List[UploadFile]
:param sort_tables: A boolean indicating whether to sort worksheets in the .xlsx file in alphabetical order.
:type sort_tables: bool
:param request: The HTTP request object.
:type request: Request
:return: A streaming response containing a .zip file with the converted files and a log file.
:rtype: StreamingResponse
:raises InvalidPayloadError: If the request payload is invalid.
:raises Exception: If the conversion fails or an unexpected error occurs.</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/convert/&quot;</span><span class="p">,</span>
             <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;convert&quot;</span><span class="p">],</span>
             <span class="n">response_class</span><span class="o">=</span><span class="n">StreamingResponse</span><span class="p">,</span>
             <span class="n">responses</span><span class="o">=</span><span class="n">zip_responses</span><span class="p">,</span>
             <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Convert files between .ags and .xlsx format&quot;</span><span class="p">,</span>
             <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Convert files between .ags and .xlsx format. Option to&quot;</span>
                          <span class="s2">&quot; sort worksheets in .xlsx file in alphabetical order.&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span><span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
                  <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UploadFile</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_file</span><span class="p">,</span>
                  <span class="n">sort_tables</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">sort_tables_form</span><span class="p">,</span>
                  <span class="n">request</span><span class="p">:</span> <span class="n">Request</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert files between .ags and .xlsx format. Option to sort worksheets in .xlsx file in alphabetical order.</span>
<span class="sd">    :param background_tasks: A background task that manages file conversion asynchronously.</span>
<span class="sd">    :type background_tasks: BackgroundTasks</span>
<span class="sd">    :param files: A list of files to be converted. Must be in .ags or .xlsx format.</span>
<span class="sd">    :type files: List[UploadFile]</span>
<span class="sd">    :param sort_tables: A boolean indicating whether to sort worksheets in the .xlsx file in alphabetical order.</span>
<span class="sd">    :type sort_tables: bool</span>
<span class="sd">    :param request: The HTTP request object.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :return: A streaming response containing a .zip file with the converted files and a log file.</span>
<span class="sd">    :rtype: StreamingResponse</span>
<span class="sd">    :raises InvalidPayloadError: If the request payload is invalid.</span>
<span class="sd">    :raises Exception: If the conversion fails or an unexpected error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sort_tables</span> <span class="o">==</span> <span class="n">SortingStrategy</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
        <span class="n">sort_tables</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidPayloadError</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">RESULTS</span> <span class="o">=</span> <span class="s1">&#39;results&#39;</span>
    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>
    <span class="n">results_dir</span> <span class="o">=</span> <span class="n">tmp_dir</span> <span class="o">/</span> <span class="n">RESULTS</span>
    <span class="n">results_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="n">full_logfile</span> <span class="o">=</span> <span class="n">results_dir</span> <span class="o">/</span> <span class="s1">&#39;conversion.log&#39;</span>
    <span class="k">with</span> <span class="n">full_logfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">local_file</span> <span class="o">=</span> <span class="n">tmp_dir</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">local_file</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">conversion</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">results_dir</span><span class="p">,</span> <span class="n">sorting_strategy</span><span class="o">=</span><span class="n">sort_tables</span><span class="p">)</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">validation</span><span class="o">.</span><span class="n">to_plain_text</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zipped_file</span> <span class="o">=</span> <span class="n">tmp_dir</span> <span class="o">/</span> <span class="n">RESULTS</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">zipped_file</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="n">results_dir</span><span class="p">)</span>
    <span class="n">zipped_stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="o">/</span> <span class="p">(</span><span class="n">RESULTS</span> <span class="o">+</span> <span class="s1">&#39;.zip&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">zipped_stream</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">zipped_stream</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/x-zip-compressed&quot;</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Disposition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;attachment; filename=</span><span class="si">{</span><span class="n">RESULTS</span><span class="si">}</span><span class="s2">.zip&quot;</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.get_ags_log" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_ags_log</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="o">=</span><span class="n">ags_log_query</span><span class="p">,</span> <span class="n">response_type</span><span class="o">=</span><span class="n">response_type_query</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get a graphical log (.pdf) for a single borehole in AGS format from the National Geoscience Data Centre.
:param bgs_loca_id: The unique identifier of the borehole to generate the log for.
:type bgs_loca_id: str
:param response_type: The type of response to return (e.g. 'attachment' to force download or 'inline'     to display in browser).
:type response_type: ResponseType, optional
:return: A response containing a .pdf file with the generated borehole log.
:rtype: Response
:raises HTTPException 404: If the specified borehole does not exist or is confidential.
:raises HTTPException 500: If the borehole generator returns an error.
:raises HTTPException 500: If the borehole generator could not be reached.</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/ags_log/&quot;</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ags_log&quot;</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Generate Graphical Log&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Generate a graphical log (.pdf) from AGS data &quot;</span>
                         <span class="s2">&quot;held by the National Geoscience Data Centre.&quot;</span><span class="p">),</span>
            <span class="n">response_class</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span>
            <span class="n">responses</span><span class="o">=</span><span class="n">pdf_responses</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ags_log</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ags_log_query</span><span class="p">,</span>
                <span class="n">response_type</span><span class="p">:</span> <span class="n">ResponseType</span> <span class="o">=</span> <span class="n">response_type_query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a graphical log (.pdf) for a single borehole in AGS format from the National Geoscience Data Centre.</span>
<span class="sd">    :param bgs_loca_id: The unique identifier of the borehole to generate the log for.</span>
<span class="sd">    :type bgs_loca_id: str</span>
<span class="sd">    :param response_type: The type of response to return (e.g. &#39;attachment&#39; to force download or &#39;inline&#39; \</span>
<span class="sd">    to display in browser).</span>
<span class="sd">    :type response_type: ResponseType, optional</span>
<span class="sd">    :return: A response containing a .pdf file with the generated borehole log.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    :raises HTTPException 404: If the specified borehole does not exist or is confidential.</span>
<span class="sd">    :raises HTTPException 500: If the borehole generator returns an error.</span>
<span class="sd">    :raises HTTPException 500: If the borehole generator could not be reached.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">BOREHOLE_VIEWER_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="o">=</span><span class="n">bgs_loca_id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Timeout</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;The borehole generator could not be reached.  Please try again later.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve borehole </span><span class="si">{</span><span class="n">bgs_loca_id</span><span class="si">}</span><span class="s2">. &quot;</span>
                                <span class="s2">&quot;It may not exist or may be confidential&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;The borehole generator returned an error.&quot;</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bgs_loca_id</span><span class="si">}</span><span class="s2">_log.pdf&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">response_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">; filename=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.ags_export" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ags_export</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="o">=</span><span class="n">ags_export_query</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Export a single borehole in .ags format from AGS data held by the National Geoscience Data Centre.
:param bgs_loca_id: The unique identifier of the borehole to export.
:type bgs_loca_id: str
:return: A response containing a .zip file with the exported borehole data.
:rtype: Response
:raises HTTPException 404: If the specified boreholes do not exist or are confidential.
:raises HTTPException 422: If more than BOREHOLE_EXPORT_LIMIT borehole IDs are supplied.
:raises HTTPException 500: If the borehole exporter returns an error.
:raises HTTPException 500: If the borehole exporter could not be reached.</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/ags_export/&quot;</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ags_export&quot;</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Export one or more boreholes in .ags format&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Export one or more borehole in .ags format from AGS data &quot;</span>
                         <span class="s2">&quot;held by the National Geoscience Data Centre.&quot;</span><span class="p">),</span>
            <span class="n">response_class</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span>
            <span class="n">responses</span><span class="o">=</span><span class="n">ags_export_responses</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ags_export</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ags_export_query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export a single borehole in .ags format from AGS data held by the National Geoscience Data Centre.</span>
<span class="sd">    :param bgs_loca_id: The unique identifier of the borehole to export.</span>
<span class="sd">    :type bgs_loca_id: str</span>
<span class="sd">    :return: A response containing a .zip file with the exported borehole data.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    :raises HTTPException 404: If the specified boreholes do not exist or are confidential.</span>
<span class="sd">    :raises HTTPException 422: If more than BOREHOLE_EXPORT_LIMIT borehole IDs are supplied.</span>
<span class="sd">    :raises HTTPException 500: If the borehole exporter returns an error.</span>
<span class="sd">    :raises HTTPException 500: If the borehole exporter could not be reached.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">BOREHOLE_EXPORT_LIMIT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;More than </span><span class="si">{</span><span class="n">BOREHOLE_EXPORT_LIMIT</span><span class="si">}</span><span class="s2"> borehole IDs.&quot;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">BOREHOLE_EXPORT_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="o">=</span><span class="n">bgs_loca_id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Timeout</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;The borehole exporter could not be reached.  Please try again later.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve borehole </span><span class="si">{</span><span class="n">bgs_loca_id</span><span class="si">}</span><span class="s2">. &quot;</span>
                                <span class="s2">&quot;It may not exist or may be confidential&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;The borehole exporter returned an error.&quot;</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">:</span> <span class="s1">&#39;attachment; filename=&quot;boreholes.zip&quot;&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;application/x-zip-compressed&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.ags_export_by_polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ags_export_by_polygon</span><span class="p">(</span><span class="n">polygon</span><span class="o">=</span><span class="n">polygon_query</span><span class="p">,</span> <span class="n">count_only</span><span class="o">=</span><span class="n">count_only_query</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Export the boreholes in .ags format from AGS data held by the National Geoscience Data Centre,
that are bounded by the polygon. If there are more than 50 boreholes return an error
:param polygon: A polygon in Well Known Text.
:type polygon: str
:param count_only: The format to return the validation results in. Options are "text" or "json".
:type count_only: int
:param request: The request object.
:type request: Request
:return: A response with the validation results in either plain text or JSON format.
:rtype: Union[BoreholeCountResponse, Response]
:return: A response containing a count or a .zip file with the exported borehole data.
:rtype: Response
:raises HTTPException 422: If there are no boreholes or more than BOREHOLE_EXPORT_LIMIT boreholes in the polygon.
:raises HTTPException 422: If the Well Known Text is not a POLYGON or is invalid.
:raises HTTPException 500: If the borehole index could not be reached.
:raises HTTPException 500: If the borehole index returns an error.
:raises HTTPException 500: If the borehole exporter could not be reached.
:raises HTTPException 500: If the borehole exporter returns an error.</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/ags_export_by_polygon/&quot;</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ags_export_by_polygon&quot;</span><span class="p">],</span>
            <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Export a number of boreholes in .ags format in a polygon&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Export a number of boreholes in .ags format from AGS data &quot;</span>
                         <span class="s2">&quot;held by the National Geoscience Data Centre, using a&quot;</span>
                         <span class="s2">&quot; polygon using Well-Known-Text.&quot;</span><span class="p">),</span>
            <span class="n">response_model</span><span class="o">=</span><span class="n">BoreholeCountResponse</span><span class="p">,</span>
            <span class="n">responses</span><span class="o">=</span><span class="n">ags_export_responses</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ags_export_by_polygon</span><span class="p">(</span><span class="n">polygon</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">polygon_query</span><span class="p">,</span>
                          <span class="n">count_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">count_only_query</span><span class="p">,</span>
                          <span class="n">request</span><span class="p">:</span> <span class="n">Request</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export the boreholes in .ags format from AGS data held by the National Geoscience Data Centre,</span>
<span class="sd">    that are bounded by the polygon. If there are more than 50 boreholes return an error</span>
<span class="sd">    :param polygon: A polygon in Well Known Text.</span>
<span class="sd">    :type polygon: str</span>
<span class="sd">    :param count_only: The format to return the validation results in. Options are &quot;text&quot; or &quot;json&quot;.</span>
<span class="sd">    :type count_only: int</span>
<span class="sd">    :param request: The request object.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :return: A response with the validation results in either plain text or JSON format.</span>
<span class="sd">    :rtype: Union[BoreholeCountResponse, Response]</span>
<span class="sd">    :return: A response containing a count or a .zip file with the exported borehole data.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    :raises HTTPException 422: If there are no boreholes or more than BOREHOLE_EXPORT_LIMIT boreholes in the polygon.</span>
<span class="sd">    :raises HTTPException 422: If the Well Known Text is not a POLYGON or is invalid.</span>
<span class="sd">    :raises HTTPException 500: If the borehole index could not be reached.</span>
<span class="sd">    :raises HTTPException 500: If the borehole index returns an error.</span>
<span class="sd">    :raises HTTPException 500: If the borehole exporter could not be reached.</span>
<span class="sd">    :raises HTTPException 500: If the borehole exporter returns an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check explicitly that the WKT is a valid POLYGON</span>
    <span class="c1"># The BOREHOLE_INDEX_URL API does not return an error for some bad WKT</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shapely</span><span class="o">.</span><span class="n">wkt</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">shapely</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">GEOSException</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid polygon&quot;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">BOREHOLE_INDEX_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polygon</span><span class="o">=</span><span class="n">polygon</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Timeout</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;The borehole index could not be reached.  Please try again later.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve boreholes for the given polygon&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;The borehole index returned an error.&quot;</span><span class="p">)</span>

    <span class="n">collection</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">collection</span><span class="p">[</span><span class="s1">&#39;numberMatched&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">count_only</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">prepare_count_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No boreholes found in the given polygon&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">BOREHOLE_EXPORT_LIMIT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;More than </span><span class="si">{</span><span class="n">BOREHOLE_EXPORT_LIMIT</span><span class="si">}</span><span class="s2"> boreholes (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">) &quot;</span>
                                <span class="s2">&quot;found in the given polygon. Please try with a smaller polygon&quot;</span><span class="p">)</span>

        <span class="n">bgs_loca_ids</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]])</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BOREHOLE_EXPORT_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bgs_loca_id</span><span class="o">=</span><span class="n">bgs_loca_ids</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ags_export</span><span class="p">(</span><span class="n">bgs_loca_ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.prepare_count_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_count_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Package the data into a BoreholeCountResponse schema object</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_count_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Package the data into a BoreholeCountResponse schema object&quot;&quot;&quot;</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Borehole count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
        <span class="s1">&#39;self&#39;</span><span class="p">:</span> <span class="n">get_request_url</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">BoreholeCountResponse</span><span class="p">(</span><span class="o">**</span><span class="n">response_data</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.routes.get_request_url" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_request_url</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>External calls need https to be returned, so check environment.</p>


            <details class="quote">
              <summary>Source code in <code>app/routes.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_request_url</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; External calls need https to be returned, so check environment.&quot;&quot;&quot;</span>
    <span class="n">request_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AGS_API_ENV</span> <span class="o">==</span> <span class="s1">&#39;PRODUCTION&#39;</span> <span class="ow">and</span> <span class="n">request_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http:&#39;</span><span class="p">):</span>
        <span class="n">request_url</span> <span class="o">=</span> <span class="n">request_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http:&#39;</span><span class="p">,</span> <span class="s1">&#39;https:&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">request_url</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>